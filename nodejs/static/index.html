<html>
  <head>
    <title>File upload</title>
  </head>
  <body>
    <form id="uploadForm"
          enctype="multipart/form-data"
          action="/api/upload"
          method="post">
      <input type="file" name="importFile" />
      <input type="submit" value="Upload" name="submit">
    </form>

    <form id="importForm"
          action="/api/import"
          method="post">

      <div id="import" style="display: none;">
        <div>
          <input type="submit" value="Import" name="import">
          <div id="importStatus">Status:</div>
        </div>
        <div>
          RFx name: <input type="text" id="rfxName" name="rfxName" required></input>
        </div>
        <div>
          URL: <input type="text" id="rfxUrl" name="rfxUrl" required></input>
        </div>
        <div>
          Skip rows: <input type="number" id="skipRows" name="skipRows" required></input>
        </div>
      </div>

      <table id="importTable" border="1" style="display: none;">
        <thead id="importTableHeader"></thead>
        <tbody></tobody>
      </table>

      <input id="importTableJSON" type="hidden" name="table">
    </form>
  </body>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
  <script>
    function status(text) {
      $("#importStatus").text("Status: " + text);
    }

    $(document).ready(function() {
      $('#importForm').submit(function() {
        $(this).ajaxSubmit({
          error: function(xhr) {
            status('Error: ' + xhr.statusText);
          },
          success: function(response) {
            console.log("imported", response);
            response = JSON.parse(response);

            if (response['status'] == "error") {
              status("Failed to import, " + response['error']['message']);
            } else {
              status("Successfully imported " + response['response']['items'].length + 
                     " items in " + response['response']['took'] + " ms." );
            }
          }
        });

        return false;
      });

      $('#uploadForm').submit(function() {
        $(this).ajaxSubmit({
          error: function(xhr) {
            status('Error: ' + xhr);
          },
          success: function(response) {

            // Reset potential previous upload
            $('#importTable').html('<thead id="importTableHeader"></thead><tbody></tbody>')
            status('');

            drawTable(response);
            $('#import').show()
            $('#importTable').show()

            function drawTable(data) {
              for (var i = 0; i < data.length; i++) {
                drawRow(i, data[i]);
              }

              $('#importTableHeader').append('<tr>');

              $('#importTableHeader').append('<th></th>');
              for (var i = 0; i < data[0].length; i++) {
                $('#importTableHeader').append( '<th>' + 
                                                '  <select name="col' + i + '">' +
                                                '    <option value=""></option>' +
                                                '    <option value="key">Key</option>' +
                                                '    <option value="question">Question</option>' +
                                                '    <option value="importance">Importance</option>' +
                                                '    <option value="response">Response</option>' +
                                                '    <option value="comment">Comment</option>' +
                                                '  </select>' +
                                                '</th>');
              }

              $('#importTableHeader').append('</tr>');
              $('#importTableJSON').val(JSON.stringify(data));
            }

            function drawRow(rowIdx, rowData) {
              var row = $('<tr />')
              $('#importTable').append(row);

              var l = rowData.length;
              row.append($('<td>' + (rowIdx+1) + '</td>'));
              for (var i = 0; i < l; i++) {
                row.append($('<td>' + rowData[i] + '</td>'));
              }
            }
          }
        });

        return false;
      });    
    });
  </script>
</html>
