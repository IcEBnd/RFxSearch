<html>
  <head>
    <title>List RFx</title>
  </head>
  <body>
    <div>
      <div id="deleteStatus">Status:</div>
    </div>
    <form id="deleteForm"
          action="/api/delete"
          method="post">
      <table id="importTable" border="1">
        <thead id="importTableHeader">
          <th>RFx name</th>
          <th>Questions</th>
          <th>Delete</th>
        </thead>
        <tbody id="importTableBody"></tobody>
      </table>
      <input id="deleteRFx" type="hidden" name="deleteRFx" value="foobar">
   </form>
  </body>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
  <script>
    var $btn;

    $(document).ready(function() {
      status('');
      updateList();

      $('#deleteForm').on('submit', function() {
        $btn = $(document.activeElement);

        if (
            /* there is an activeElement at all */
            $btn.length &&

            /* it's a child of the form */ 
            $('#deleteForm').has($btn) &&

            /* it's really a submit element */
            $btn.is('button[type="submit"], input[type="submit"], input[type="image"]') &&

            /* it has a "name" attribute */
            $btn.is('[name]')
        ) {
            //console.log("Seems, that this element was clicked:", $btn);
            /* access $btn.attr("name") and $btn.val() for data */
            console.log($btn.val());
        }

        var r = confirm("Delete " + $btn.val() + "?");
        console.log(r);

        if(r) {
          $('#deleteRFx').val($btn.val());
          status("Deleting..");
          $(this).ajaxSubmit({
            error: function(xhr) {
              status('Error: ' + xhr.statusText);
            },
            success: function(response) {
              console.log("deleted", response);

              if (response['status'] == "error") {
                status('Failed to delete "' + $('#deleteRFx').val() + '", ' + response.error);
              } else {
                status('Successfully deleted ' +  response.response.rfx);
              }

              updateList();
            }
          });
        }

        return false;
      });

      function drawRow(rowIdx, rowData) {
        var row = $('<tr />')
        $('#importTable').append(row);

        var l = rowData.length;
        //row.append($('<td>' + (rowIdx+1) + '</td>'));
        for (var i = 0; i < l; i++) {
          row.append($('<td>' + rowData[i] + '</td>'));
        }

        row.append('<input type="submit" value="' + rowData[0] + '" name="delete' + rowIdx + '">')
      }

      function status(text) {
        $("#deleteStatus").text("Status: " + text);
      }

      function updateList() {
        $('#importTableBody').empty();
        $.getJSON( "api/list", function( response ) {
          //var data = [['virgin media', 5], ['asd', 7]];
          var data = JSON.parse(response.response);

          for (var i = 0; i < data.length; i++) {
            drawRow(i, data[i]);
          }
  /*
          var items = [];
          $.each( data, function( key, val ) {
            items.push( "<li id='" + key + "'>" + val + "</li>" );
          });
         
          $( "<ul/>", {
            "class": "my-new-list",
            html: items.join( "" )
          }).appendTo( "body" );
  */
        });
      }


      /*
      $('#importForm').submit(function() {
        status("Importing..");
        $(this).ajaxSubmit({
          error: function(xhr) {
            status('Error: ' + xhr.statusText);
          },
          success: function(response) {
            console.log("imported", response);
            response = JSON.parse(response);

            if (response['status'] == "error") {
              status("Failed to import, " + response['error']['message']);
            } else {
              status("Successfully imported " + response['response']['items'].length + 
                     " items in " + response['response']['took'] + " ms." );
            }
          }
        });

        return false;
      });
*/



/*
      $('#uploadForm').submit(function() {
        $(this).ajaxSubmit({
          error: function(xhr) {
            status('Error: ' + xhr);
          },
          success: function(response) {

            // Reset potential previous upload
            $('#importTable').html('<thead id="importTableHeader"></thead><tbody></tbody>')
            status('');

            drawTable(response);
            $('#import').show()
            $('#importTable').show()

            function drawTable(data) {
              for (var i = 0; i < data.length; i++) {
                drawRow(i, data[i]);
              }

              $('#importTableHeader').append('<tr>');

              $('#importTableHeader').append('<th></th>');
              for (var i = 0; i < data[0].length; i++) {
                $('#importTableHeader').append( '<th>' + 
                                                '  <select name="col' + i + '">' +
                                                '    <option value=""></option>' +
                                                '    <option value="key">Key</option>' +
                                                '    <option value="question">Question</option>' +
                                                '    <option value="importance">Importance</option>' +
                                                '    <option value="response">Response</option>' +
                                                '    <option value="comment">Comment</option>' +
                                                '  </select>' +
                                                '</th>');
              }

              $('#importTableHeader').append('</tr>');
              $('#importTableJSON').val(JSON.stringify(data));
            }

            function drawRow(rowIdx, rowData) {
              var row = $('<tr />')
              $('#importTable').append(row);

              var l = rowData.length;
              row.append($('<td>' + (rowIdx+1) + '</td>'));
              for (var i = 0; i < l; i++) {
                row.append($('<td>' + rowData[i] + '</td>'));
              }
            }
          }
        });

        return false;
      });  */  
    });
  </script>
</html>
